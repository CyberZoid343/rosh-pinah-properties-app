<div class="container-fluid p-3 text-nowrap">
    <div class="row">
        <div class="col-12 mb-3">
            <div class="d-flex align-items-center">
                <h3 class="mb-0 me-2">Clients</h3>
                <button class="btn btn-outline-primary ms-auto" (click)="exportExcel()">
                    <i class="fa-solid fa-download me-2"></i>Export List
                </button>
                <button class="btn btn-primary ms-2" (click)="openClientFormDialog(0)">
                    <i class="fa-solid fa-plus me-2"></i>Add New Client
                </button>
            </div>
        </div>
        <div class="col-12 mb-3">
            <div class="d-flex align-items-center bg-light pt-3 px-3 rounded border flex-xl-nowrap flex-wrap">
                <div class="input-group flex-nowrap me-xl-2 mb-3">
                    <span class="input-group-text bg-white"><i class="fa-solid fa-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search..."
                        (keyup)="searchClients($event)">
                </div>
                <div class="dropdown me-2 mb-3">
                    <button class="btn bg-white border" data-bs-toggle="dropdown">
                        <span class="me-2">Status:</span>
                        <b class="text-capitalize">{{status}}</b>
                        <i class="fa-solid fa-caret-down ms-1"></i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                        <li><a class="dropdown-item" (click)="filterByStatus('all')">All</a></li>
                        <li><a class="dropdown-item" (click)="filterByStatus('active')">Active</a></li>
                        <li><a class="dropdown-item" (click)="filterByStatus('inactive')">Inactive</a></li>
                    </ul>
                </div>
                <div class="dropdown me-2 mb-3">
                    <button class="btn bg-white border" data-bs-toggle="dropdown">
                        <span class="me-2">Follow up:</span>
                        <b class="text-capitalize">{{followUp}}</b>
                        <i class="fa-solid fa-caret-down ms-1"></i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                        <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('all')">All</a></li>
                        <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('today')">Today</a></li>
                        <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('tomorrow')">Tomorrow</a></li>
                        <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('overdue')">Overdue</a></li>
                    </ul>
                </div>
                <div class="dropdown me-2 mb-3">
                    <button class="btn bg-white border" data-bs-toggle="dropdown">
                        <span class="me-2">Last contacted:</span>
                        <b class="text-capitalize">{{lastContacted}}</b>
                        <i class="fa-solid fa-caret-down ms-1"></i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                        <li><a class="dropdown-item" (click)="filterByLastContactedPeriod('all')">All</a></li>
                        <li><a class="dropdown-item" (click)="filterByLastContactedPeriod('today')">Today</a></li>
                        <li><a class="dropdown-item" (click)="filterByLastContactedPeriod('yesterday')">Yesterday</a>
                        </li>   
                    </ul>
                </div>
                <button class="btn bg-white border me-2 mb-3" data-bs-toggle="offcanvas" 
                    data-bs-target="#offcanvasScrolling">
                    <i class="fa-solid fa-filter me-2"></i>More Filters
                </button>
                <button class="btn bg-white border me-2 mb-3" (click)="clearFilters()">
                    <i class="fa-solid fa-filter-circle-xmark me-2"></i>Clear Filters
                </button>
                <button class="btn bg-white border mb-3" (click)="refreshClientList()">
                    <i class="fa-solid fa-refresh me-2"></i>Refresh
                </button>
            </div>
        </div>
        <div class="col-12">
            <div class="d-flex flex-wrap align-items-center">
                <span class="me-4 mb-3"><i class="fa-solid fa-list me-1"></i>Results found: <b>{{clients.length}}</b></span>
                <span class="me-4 mb-3"><i class="fa-solid fa-circle-check text-success me-1"></i>Active: <b>{{totalActive}}</b></span>
                <span class="me-4 mb-3"><i class="fa-solid fa-circle-xmark text-danger me-1"></i>Inactive: <b>{{totalInactive}}</b></span>
                <span class="me-4 mb-3"><i class="fa-solid fa-triangle-exclamation text-warning me-1"></i>Follow up tomorrow: <b>{{totalFollowUpTomorrow}}</b></span>
                <span class="me-4 mb-3"><i class="fa-solid fa-comment-dots text-success me-1"></i>Follow up today: <b>{{totalFollowUpToday}}</b></span>
                <span class="me-4 mb-3"><i class="fa-solid fa-circle-exclamation text-danger me-1"></i>Follow up overdue: <b>{{totalFollowUpOverdue}}</b></span>
                <div class="dropdown ms-auto mb-3">
                    <button class="btn" data-bs-toggle="dropdown">
                        <span class="me-2">Order by:</span>
                        <b class="text-capitalize">{{order}}</b>
                        <i class="fa-solid fa-caret-down ms-1"></i>
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                        <li><a class="dropdown-item" (click)="orderBy('date_added')">Date Added</a></li>
                        <li><a class="dropdown-item" (click)="orderBy('date_updated')">Date Updated</a></li>
                        <li><a class="dropdown-item" (click)="orderBy('name')">Name</a></li>
                        <li><a class="dropdown-item" (click)="orderBy('surname')">Surname</a></li>
                        <li><a class="dropdown-item" (click)="orderBy('company')">Company</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-12">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Client</th>
                        <th scope="col">Company</th>
                        <th scope="col">Tags</th>
                        <th scope="col">Last Contacted</th>
                        <th scope="col">Follow Up</th>
                        <th scope="col" class="d-none">Updated</th>
                        <th scope="col">Added</th>
                        <th scope="col">Updated</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngIf="gettingClientSet">
                        <td colspan="12" class="text-center">
                            <app-loading-indicator [message]="loadingClientsMessage"></app-loading-indicator>
                        </td>
                    </tr>
                    <tr *ngIf="clients.length == 0 && !gettingClientSet">
                        <td colspan="12" class="text-center">
                            <span>No data found</span>
                        </td>
                    </tr>
                    <tr *ngFor="let client of clients" class="align-middle">
                        <td>
                            <span class="d-block">{{client.name}} {{client.surname}}</span>
                            <small class="text-muted">{{client.email}}</small>
                        </td>
                        <td>{{client.companyName}}</td>
                        <td class="text-wrap" style="max-width: 300px;">
                            <span class="badge rounded-pill bg-transparent-primary" style="margin: 1px;"
                                *ngFor="let tag of client.tagArray"
                                [ngClass]="{'bg-primary text-white': highlighIfInTagFilter(tag)}">{{tag}}</span>
                        </td>
                        <td style="max-width: 120px" class="text-truncate">
                            <span class="d-block">
                                {{client.dateLastContacted | date: "mediumDate"}}
                            </span>
                            <small class="text-muted" *ngIf="client.lastContactedDays! < -1">{{client.lastContactedDays!
                                * -1}} days ago</small>
                            <small class="text-muted" *ngIf="client.lastContactedDays! == -1">Yesterday</small>
                            <small class="text-muted" *ngIf="client.lastContactedDays! == 0">Today</small>
                        </td>
                        <td style="max-width: 120px" class="text-truncate">

                            <div class="d-flex align-items-center">
                                <span *ngIf="client.isActive">
                                    <i class="fa-solid fa-circle-exclamation text-danger me-1"
                                        *ngIf="client.followUpDays! < 0"></i>
                                    <i class="fa-solid fa-triangle-exclamation text-warning me-1"
                                        *ngIf="client.followUpDays! == 1"></i>
                                    <i class="fa-solid fa-comment-dots text-success me-1"
                                        *ngIf="client.followUpDays! == 0"></i>
                                </span>
                                <span>{{client.dateFollowUp | date: "mediumDate"}}</span>
                            </div>
                            <div class="d-block">
                                <small class="text-muted" *ngIf="client.followUpDays! < -1">{{client.followUpDays! *
                                    -1}}
                                    days overdue </small>
                                <small class="text-muted" *ngIf="client.followUpDays! == -1">Due yesterday</small>
                                <small class="text-muted" *ngIf="client.followUpDays! == 0">Due today</small>
                                <small class="text-muted" *ngIf="client.followUpDays! == 1">Due tomorrow</small>
                                <small class="text-muted" *ngIf="client.followUpDays! > 1">Due in
                                    {{client.followUpDays!}}
                                    days</small>
                            </div>
                        </td>
                        <td style="max-width: 120px" class="text-truncate d-none">
                            <span class="d-block">{{client.dateUpdated | date: "mediumDate"}}</span>
                            <small class="text-muted" *ngIf="client.updatedDays! == 0">Today by</small>
                            <small class="text-muted" *ngIf="client.updatedDays! == -1">Yesterday by</small>
                            <small class="text-muted" *ngIf="client.updatedDays! < -1">{{client.updatedDays! * -1}} days
                                ago by</small>
                            <small class="text-muted d-block">{{client.lastEditor!.name}}
                                {{client.lastEditor!.surname}}</small>
                        </td>
                        <td>
                            <span class="d-block">{{client.dateAdded | date: "mediumDate"}}</span>
                            <small class="text-muted" *ngIf="client.addedDays! < -1">{{client.lastContactedDays!
                                * -1}} days ago</small>
                            <small class="text-muted" *ngIf="client.addedDays! == -1">Yesterday</small>
                            <small class="text-muted" *ngIf="client.addedDays! == 0">Today</small>
                        </td>
                        <td>
                            <span class="d-block">{{client.dateUpdated | date: "mediumDate"}}</span>
                            <small class="text-muted" *ngIf="client.updatedDays! < -1">{{client.lastContactedDays!
                                * -1}} days ago</small>
                            <small class="text-muted" *ngIf="client.updatedDays! == -1">Yesterday</small>
                            <small class="text-muted" *ngIf="client.updatedDays! == 0">Today</small>
                        </td>
                        <td style="max-width: 50px;">
                            <span *ngIf="client.isActive" class="badge rounded-pill bg-transparent-success"
                                [ngClass]="{'bg-success text-white': status=='active'}">Active</span>
                            <span *ngIf="!client.isActive" class="badge rounded-pill bg-transparent-danger"
                                [ngClass]="{'bg-danger text-white': status=='inactive'}">Inactive</span>
                        </td>
                        <td style="width: 0px;">
                            <div class="d-flex justify-content-end">
                                <div class="dropdown">
                                    <button class="btn" data-bs-toggle="dropdown" ngbTooltip="Actions"
                                        placement="bottom">
                                        <i class="fa-solid fa-ellipsis"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <button class="dropdown-item" (click)="openClientDetailsDialog(client.id)">
                                                <i class="fa-solid fa-folder-open me-2"></i>
                                                Details
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" (click)="openClientFormDialog(client.id)">
                                                <i class="fa-solid fa-pen me-2"></i>
                                                Edit
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item">
                                                <i class="fa-solid fa-note-sticky me-2"></i>
                                                Notes
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" (click)="updateClientStatus(client)"
                                                *ngIf="!client.isActive">
                                                <i class="fa-solid fa-circle-check me-2"></i>
                                                Mark Active
                                            </button>
                                        </li>
                                        <hr class="dropdown-divider">
                                        <li>
                                            <button class="dropdown-item text-danger"
                                                (click)="updateClientStatus(client)" *ngIf="client.isActive">
                                                <i class="fa-solid fa-circle-xmark me-2"></i>
                                                Mark Inactive
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item text-danger" (click)="deleteClient(client.id)">
                                                <i class="fa-solid fa-trash me-2"></i>
                                                Delete
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end " data-bs-scroll="true" data-bs-backdrop="false" id="offcanvasScrolling">
    <div class="offcanvas-header border-bottom border-top">
        <h5 class="offcanvas-title">Filters</h5>
        <button class="btn border" data-bs-dismiss="offcanvas">Close</button>
    </div>
    <div class="offcanvas-body">
        <app-client-filters></app-client-filters>
    </div>
</div>