<div class="d-flex align-items-center text-nowrap bg-white border-bottom px-3 py-2 sticky-top">
    <div class="bg-transparent-primary rounded h5 p-2 mb-0 me-2 text-center">
        <i class="fa-solid fa-address-book" style="width: 20px;"></i>
    </div>
    <h4 class="me-auto my-0">Clients</h4>
    <button class="btn btn-secondary ms-2" (click)="exportExcel()">
        <i class="fa-solid fa-file-excel me-2"></i>Export Excel
    </button>
    <button class="btn btn-primary ms-2" (click)="openClientFormDialog(0)">
        <i class="fa-solid fa-plus me-2"></i>Add New Client
    </button>
</div>
<div class="d-flex align-items-center text-nowrap p-3">

    <div class="input-group">
        <i class="fa-solid fa-magnifying-glass input-search-icon"></i>
        <input type="text" class="form-control input-search border rounded-start"
            placeholder="Search..." value="{{search}}" (keyup)="searchClients($event)">
        <button class="btn border bg-white" data-bs-toggle="dropdown">
            <span class="me-2">Status:</span>
            <b class="text-capitalize">{{status}}</b>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li><a class="dropdown-item" (click)="filterByStatus('all')">All</a></li>
            <li><a class="dropdown-item" (click)="filterByStatus('active')">Active</a></li>
            <li><a class="dropdown-item" (click)="filterByStatus('inactive')">Inactive</a></li>
        </ul>
        <button class="btn border bg-white" data-bs-toggle="dropdown">
            <span class="me-2">Follow up:</span>
            <b class="text-capitalize">{{followUp}}</b>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('all')">All</a></li>
            <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('today')">Today</a></li>
            <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('tomorrow')">Tomorrow</a></li>
            <li><a class="dropdown-item" (click)="filterByFollowUpPeriod('overdue')">Overdue</a></li>
        </ul>
        <button class="btn border bg-white" data-bs-toggle="dropdown">
            <span class="me-2">Last contacted:</span>
            <b class="text-capitalize">{{lastContacted}}</b>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li><a class="dropdown-item" (click)="filterByLastContactedPeriod('all')">All</a></li>
            <li><a class="dropdown-item" (click)="filterByLastContactedPeriod('today')">Today</a></li>
            <li><a class="dropdown-item" (click)="filterByLastContactedPeriod('yesterday')">Yesterday</a>
            </li>
        </ul>
        <button class="btn border bg-white rounded-start-0" data-bs-toggle="dropdown">
            <span class="me-2">Order by:</span>
            <b class="text-capitalize">{{order}}</b>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
            <li><a class="dropdown-item" (click)="orderBy('recently_added')">Recently Added</a></li>
            <li><a class="dropdown-item" (click)="orderBy('recently_updated')">Recently Updated</a></li>
            <li><a class="dropdown-item" (click)="orderBy('name')">Name</a></li>
            <li><a class="dropdown-item" (click)="orderBy('surname')">Surname</a></li>
            <li><a class="dropdown-item" (click)="orderBy('company')">Company</a></li>
        </ul>
        <button class="btn border bg-white" data-bs-toggle="offcanvas"
            data-bs-target="#offcanvasScrolling">
            <i class="fa-solid fa-filter me-2"></i> More Filters
        </button>
        <button class="btn border bg-white" (click)="clearFilters()">
            <i class="fa-solid fa-filter-circle-xmark me-2"></i>Clear Filters
        </button>
    </div>
</div>
<div class="d-flex align-items-center text-nowrap px-3 mb-3">
    <span class="me-4"><i class="fa-solid fa-list me-2"></i>Results found: <b>{{clients.length}}</b></span>
    <span class="me-4">|</span>
    <span class="me-4"><i class="fa-solid fa-circle-check text-success me-2"></i>Active: <b>{{totalActive}}</b></span>
    <span class="me-4"><i class="fa-solid fa-circle-xmark text-danger me-2"></i>Inactive: <b>{{totalInactive}}</b></span>
    <span class="me-4">|</span>
    <span class="me-4"><i class="fa-solid fa-triangle-exclamation text-warning me-2"></i>Follow up tomorrow: <b>{{totalFollowUpTomorrow}}</b></span>
    <span class="me-4"><i class="fa-solid fa-comment-dots text-success me-2"></i>Follow up today: <b>{{totalFollowUpToday}}</b></span>
    <span class="me-4"><i class="fa-solid fa-circle-exclamation text-danger me-2"></i>Follow up overdue: <b>{{totalFollowUpOverdue}}</b></span>
</div>
<div class="px-3">
    <table class="table border text-nowrap">
        <tbody class="bg-white">
            <tr class="table-dark align-middle border">
                <th scope="col">Client</th>
                <th scope="col">Tags</th>
                <th scope="col">Last Contacted</th>
                <th scope="col">Follow Up</th>
                <th scope="col">Updated</th>
                <th scope="col">Status</th>
                <th scope="col" class="text-end">
                    <button class="btn text-white py-0" ngbTooltip="Refresh" placement="bottom"
                        (click)="refreshClientList()">
                        <i class="fa-solid fa-refresh"></i>
                    </button>
                </th>
            </tr>
            <tr *ngIf="gettingClientSet" class="align-middle">
                <td colspan="12" class="text-center">
                    <app-loading-indicator [message]="loadingClientsMessage"></app-loading-indicator>
                </td>
            </tr>
            <tr *ngIf="clients.length == 0 && !gettingClientSet" class="align-middle">
                <td colspan="12" class="text-center">
                    <span>No data found</span>
                </td>
            </tr>
            <tr *ngFor="let client of clients" class="align-middle table-row-hover-light">
                <td>
                    <b class="d-block">{{client.name}} {{client.surname}}</b>
                    <small class="text-muted">{{client.companyName}}</small>
                </td>
                <td class="text-wrap" style="max-width: 300px;">
                    <span class="badge rounded-pill bg-transparent-primary" style="margin: 1px;"
                        *ngFor="let tag of client.tagArray"
                        [ngClass]="{'bg-primary text-white': highlighIfInTagFilter(tag)}">{{tag}}</span>
                </td>
                <td>
                    <span class="d-block">
                        {{client.dateLastContacted | date: "mediumDate"}}
                    </span>
                    <small class="text-muted" *ngIf="client.lastContactedDays! < -1">{{client.lastContactedDays!
                        * -1}} days ago</small>
                    <small class="text-muted" *ngIf="client.lastContactedDays! == -1">Yesterday</small>
                    <small class="text-muted" *ngIf="client.lastContactedDays! == 0">Today</small>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <span *ngIf="client.isActive">
                            <i class="fa-solid fa-circle-exclamation text-danger me-1"
                                *ngIf="client.followUpDays! < 0"></i>
                            <i class="fa-solid fa-triangle-exclamation text-warning me-1"
                                *ngIf="client.followUpDays! == 1"></i>
                            <i class="fa-solid fa-comment-dots text-success me-1" *ngIf="client.followUpDays! == 0"></i>
                        </span>
                        <span>{{client.dateFollowUp | date: "mediumDate"}}</span>
                    </div>
                    <div class="d-block">
                        <small class="text-muted" *ngIf="client.followUpDays! < -1">{{client.followUpDays! *
                            -1}}
                            days overdue </small>
                        <small class="text-muted" *ngIf="client.followUpDays! == -1">Due yesterday</small>
                        <small class="text-muted" *ngIf="client.followUpDays! == 0">Due today</small>
                        <small class="text-muted" *ngIf="client.followUpDays! == 1">Due tomorrow</small>
                        <small class="text-muted" *ngIf="client.followUpDays! > 1">Due in
                            {{client.followUpDays!}}
                            days</small>
                    </div>
                </td>
                <td>
                    <span class="d-block">{{client.dateUpdated | date: "mediumDate"}} {{client.dateUpdated | date:
                        "shortTime"}}</span>
                    <small class="text-muted" *ngIf="client.updatedDays! < -1">{{client.lastContactedDays!
                        * -1}} days ago</small>
                    <small class="text-muted" *ngIf="client.updatedDays! == -1">Yesterday</small>
                    <small class="text-muted" *ngIf="client.updatedDays! == 0">Today</small>
                </td>
                <td>
                    <span *ngIf="client.isActive" class="badge rounded-pill bg-transparent-success"
                        [ngClass]="{'bg-success text-white': status=='active'}">Active</span>
                    <span *ngIf="!client.isActive" class="badge rounded-pill bg-transparent-danger"
                        [ngClass]="{'bg-danger text-white': status=='inactive'}">Inactive</span>
                </td>
                <td>
                    <div class="d-flex justify-content-end">
                        <div class="dropdown">
                            <button class="btn btn-secondary" (click)="openClientDetailsDialog(client.id)"><i
                                    class="fa-solid fa-folder-open me-2"></i>Details</button>
                            <button class="btn" data-bs-toggle="dropdown" ngbTooltip="Actions" placement="bottom">
                                <i class="fa-solid fa-ellipsis-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li>
                                    <button class="dropdown-item" (click)="openClientFormDialog(client.id)">
                                        <i class="fa-solid fa-pen me-2"></i>
                                        Edit
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" (click)="openClientNotesDialog(client.id)">
                                        <i class="fa-solid fa-note-sticky me-2"></i>
                                        Notes
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item" (click)="updateClientStatus(client)"
                                        *ngIf="!client.isActive">
                                        <i class="fa-solid fa-circle-check me-2"></i>
                                        Mark as Active
                                    </button>
                                </li>
                                <hr class="dropdown-divider">
                                <li>
                                    <button class="dropdown-item text-danger" (click)="updateClientStatus(client)"
                                        *ngIf="client.isActive">
                                        <i class="fa-solid fa-circle-xmark me-2"></i>
                                        Mark as Inactive
                                    </button>
                                </li>
                                <li>
                                    <button class="dropdown-item text-danger" (click)="deleteClient(client.id)">
                                        <i class="fa-solid fa-trash me-2"></i>
                                        Delete
                                    </button>
                                </li>
                            </ul>

                        </div>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div class="offcanvas offcanvas-end " data-bs-scroll="true" data-bs-backdrop="false" id="offcanvasScrolling">
    <div class="offcanvas-header border-bottom border-top justify-content-start py-2" style="height: 53px;">
        <h5 class="offcanvas-title mb-0">Filters</h5>
        <button class="btn p-0 ms-auto" ngbTooltip="Close" placement="bottom" data-bs-dismiss="offcanvas"><i
                class="fa-solid fa-xmark" style="font-size: 18px;"></i></button>
    </div>
    <div class="offcanvas-body">
        <app-client-filters></app-client-filters>
    </div>
</div>